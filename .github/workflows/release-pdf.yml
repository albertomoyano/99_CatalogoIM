name: Generar y Publicar Cat√°logo

on:
  push:
    paths:
      - '**/*.pdf'
    branches:
      - main
  workflow_dispatch:

jobs:
  procesar-y-publicar:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    # Paso 1: Obtener el c√≥digo
    - name: Checkout repository
      uses: actions/checkout@v4
      
    # Paso 2: Configurar Python
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    # Paso 3: Instalar dependencias
    - name: Install dependencies
      run: pip install PyPDF2
      
    # Paso 4: Ejecutar tu script de combinaci√≥n
    - name: Combinar PDFs
      id: combine
      run: |
        python combine_pdfs.py
        echo "PDF_PATH=docs/catalogo_ediciones_imago_mundi.pdf" >> $GITHUB_ENV
        echo "PDF_SIZE=$(du -h docs/catalogo_ediciones_imago_mundi.pdf | cut -f1)" >> $GITHUB_ENV
      
    # Paso 5: Espera expl√≠cita para asegurar que el archivo est√© listo
    - name: Esperar estabilizaci√≥n del archivo
      run: sleep 10
      
    # Paso 6: Verificaci√≥n exhaustiva del PDF
    - name: Validar PDF generado
      run: |
        if [ ! -f "$PDF_PATH" ]; then
          echo "::error::El archivo PDF no se gener√≥"
          exit 1
        fi
        
        if [ $(stat -c%s "$PDF_PATH") -lt 10000 ]; then
          echo "::error::El PDF parece demasiado peque√±o"
          exit 1
        fi
        
        echo "‚úî PDF v√°lido generado en $PDF_PATH"
        echo "Tama√±o: $PDF_SIZE"
      
    # Paso 7: Creaci√≥n del release (con token expl√≠cito)
    - name: Crear Release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        name: "Cat√°logo Ediciones Imago Mundi - $(date +'%d-%m-%Y')"
        body: |
          üìÖ Generado autom√°ticamente el $(date +'%d/%m/%Y a las %H:%M')
          üìÑ Tama√±o del archivo: ${{ env.PDF_SIZE }}
          
          Contiene todos los documentos combinados en orden cronol√≥gico.
        tag_name: "release-$(date +'%Y%m%d-%H%M')"
        files: |
          ${{ env.PDF_PATH }}
        draft: false
        prerelease: false